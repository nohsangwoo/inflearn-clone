<!DOCTYPE html>
<html>
<head>
    <title>Origin Audio HLS Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-button {
            padding: 10px 20px;
            margin: 10px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover { background: #138496; }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #17a2b8;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .highlight { background: #e7f5ff; padding: 15px; border-left: 4px solid #339af0; margin: 15px 0; }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 원본 오디오 HLS 처리 테스트</h1>

        <div class="highlight">
            <strong>새로운 기능: 원본 오디오도 HLS 스트리밍으로!</strong><br>
            언어 코드 <code>origin</code>으로 원본 오디오를 관리하고,<br>
            다른 더빙 언어들과 동일하게 HLS 세그먼트로 처리합니다.
        </div>

        <h2>🔧 구현된 기능:</h2>
        <ul>
            <li>✅ 원본 오디오를 <code>origin</code> 언어 코드로 DubTrack에 저장</li>
            <li>✅ 원본 비디오에서 오디오 추출 (ffmpeg -vn)</li>
            <li>✅ 원본 오디오도 HLS 세그먼트로 변환</li>
            <li>✅ 언어 선택에서 "원본"이 항상 첫 번째 옵션</li>
            <li>✅ 기본 선택 언어를 원본으로 설정</li>
            <li>✅ 중복 처리 방지 (이미 존재하면 스킵)</li>
        </ul>

        <h2>📝 예상 Master.m3u8 형식:</h2>
        <div class="code-block">
#EXTM3U
#EXT-X-VERSION:7
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="aud",NAME="원본",LANGUAGE="origin",AUTOSELECT=YES,DEFAULT=YES,URI="audio/origin/audio.m3u8"
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="aud",NAME="ja",LANGUAGE="ja",AUTOSELECT=YES,DEFAULT=NO,URI="audio/ja/audio.m3u8"
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="aud",NAME="zh",LANGUAGE="zh",AUTOSELECT=YES,DEFAULT=NO,URI="audio/zh/audio.m3u8"
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="aud",NAME="en",LANGUAGE="en",AUTOSELECT=YES,DEFAULT=NO,URI="audio/en/audio.m3u8"
#EXT-X-STREAM-INF:BANDWIDTH=2500000,CODECS="avc1.4d401f,mp4a.40.2",RESOLUTION=1920x1080,AUDIO="aud"
video/video.m3u8
        </div>

        <h2>🧪 테스트 방법:</h2>

        <button class="test-button" onclick="checkOriginTrack()">원본 트랙 확인</button>
        <button class="test-button" onclick="checkMasterPlaylist()">Master Playlist 확인</button>
        <button class="test-button" onclick="checkOriginAudio()">원본 오디오 HLS 확인</button>

        <div id="result"></div>

        <h2>💡 구현 로직:</h2>

        <h3>1. DubTrack 생성 (dubbing.ts)</h3>
        <div class="code-block">
// 원본 오디오 트랙 확인/생성
const originTrack = await prisma.dubTrack.findUnique({
    where: { videoId_lang: { videoId: video.id, lang: "origin" } }
});

if (!originTrack) {
    await prisma.dubTrack.create({
        data: {
            videoId: video.id,
            lang: "origin",
            status: "ready",
            url: originalVideoUrl
        }
    });
}
        </div>

        <h3>2. HLS 변환 (dubbing.ts)</h3>
        <div class="code-block">
// 원본 + 더빙 언어 모두 처리
const allLanguagesToProcess = ["origin", ...body.targetLanguages];

for (const lang of allLanguagesToProcess) {
    if (lang === "origin") {
        // 비디오에서 오디오 추출
        await execa("ffmpeg", [
            "-i", videoUrl,
            "-vn",  // 비디오 제거
            "-acodec", "pcm_s16le",
            "-ar", "48000",
            "-ac", "2",
            "origin.wav"
        ]);
    }
    // HLS 세그먼트 생성...
}
        </div>

        <h3>3. 프론트엔드 표시 (hls-player-modal.tsx)</h3>
        <div class="code-block">
// 언어 맵에 원본 추가
const langNameMap = {
    origin: "원본",
    ko: "한국어",
    ja: "일본어",
    // ...
};

// 원본을 첫 번째로 정렬
tracks.sort((a, b) => {
    if (a.language === "origin") return -1;
    if (b.language === "origin") return 1;
    return 0;
});
        </div>
    </div>

    <script>
        async function checkOriginTrack() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result';
            resultDiv.innerHTML = `🔍 원본 트랙 확인 중...\n\n` +
                `DB에서 lang='origin'인 DubTrack 레코드를 확인합니다.\n` +
                `이 트랙은 원본 비디오의 오디오를 참조합니다.`;
        }

        async function checkMasterPlaylist() {
            const resultDiv = document.getElementById('result');
            try {
                const response = await fetch('https://storage.lingoost.com/assets/curriculumsection/3/master.m3u8');
                const content = await response.text();
                const hasOrigin = content.includes('origin');

                resultDiv.className = 'result';
                resultDiv.innerHTML = `📄 Master Playlist 내용:\n\n${content}\n\n` +
                    `원본 트랙 포함 여부: ${hasOrigin ? '✅ 포함됨' : '❌ 없음'}`;
            } catch (error) {
                resultDiv.className = 'result';
                resultDiv.innerHTML = `❌ 오류: ${error.message}`;
            }
        }

        async function checkOriginAudio() {
            const resultDiv = document.getElementById('result');
            const originUrl = 'https://storage.lingoost.com/assets/curriculumsection/3/audio/origin/audio.m3u8';

            try {
                const response = await fetch(originUrl);
                if (response.ok) {
                    const content = await response.text();
                    resultDiv.className = 'result';
                    resultDiv.innerHTML = `✅ 원본 오디오 HLS 존재!\n\nURL: ${originUrl}\n\n내용:\n${content}`;
                } else {
                    resultDiv.className = 'result';
                    resultDiv.innerHTML = `❌ 원본 오디오 HLS가 아직 생성되지 않았습니다.\n\nURL: ${originUrl}\nStatus: ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result';
                resultDiv.innerHTML = `❌ 오류: ${error.message}`;
            }
        }
    </script>
</body>
</html>